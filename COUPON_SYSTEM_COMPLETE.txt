# Coupon System Implementation Complete

## Overview
A complete admin-controlled coupon system with dual-discount support (combining with day-based pricing), user assignment, slot-wise filtering, and comprehensive backend validation.

## Architecture

### Database Schema
**File**: `models/Coupon.ts`
- Stores all coupon information with 24+ fields
- Indexes for performance (code, isActive+expiryDate, assignedUsers, createdAt)
- Enums for validation (discountType, bookingType, sports)

### Key Fields
```
code: String (unique, uppercase, 3-20 chars, alphanumeric)
discountType: 'flat' | 'percent'
discountValue: Number (>=0)
applicableSlots: [{date: "YYYY-MM-DD", slot: "HH:MM-HH:MM"}]
sport: String[] (Cricket/Football/Badminton, empty=all)
bookingType: 'match' | 'practice' | 'both'
assignedUsers: String[] (emails, empty=all users)
minAmount: Number (minimum booking amount required)
expiryDate: Date
usageLimit: Number (0=unlimited)
usedCount: Number (current usage count)
perUserLimit: Number (per-user cap)
isActive: Boolean (admin can disable)
createdBy: String (admin ID)
timestamps: true (createdAt, updatedAt)
```

## APIs Created

### Admin Coupon Management

#### 1. Create Coupon
- **Endpoint**: `POST /api/admin/coupons/create`
- **Auth**: Admin token required
- **Input**: All coupon fields
- **Response**: 201 Created | 400 Bad Request | 401 Unauthorized | 409 Conflict (code exists)
- **Validation**: Code uniqueness, discount value range, required fields

#### 2. List Coupons
- **Endpoint**: `GET /api/admin/coupons/list`
- **Auth**: Admin token required
- **Query Params**: 
  - `isActive` (boolean)
  - `sport` (string)
  - `page` (number, default: 1)
  - `limit` (number, default: 10)
- **Response**: Paginated coupon list

#### 3. Update Coupon
- **Endpoint**: `PUT /api/admin/coupons/update`
- **Auth**: Admin token required
- **Input**: Coupon ID + fields to update
- **Response**: 200 OK | 404 Not Found | 400 Bad Request
- **Note**: Cannot update code (immutable)

#### 4. Delete Coupon
- **Endpoint**: `DELETE /api/admin/coupons/delete`
- **Auth**: Admin token required
- **Input**: Coupon ID
- **Response**: 200 OK | 404 Not Found

#### 5. Toggle Coupon Status
- **Endpoint**: `PATCH /api/admin/coupons/toggle`
- **Auth**: Admin token required
- **Input**: {id, isActive (boolean)}
- **Response**: 200 OK | 404 Not Found

### User Coupon APIs

#### 1. Validate Coupon
- **Endpoint**: `POST /api/coupons/validate`
- **No Auth Required** (user email provided in body)
- **Input**: 
  ```json
  {
    "code": "SUMMER20",
    "bookingType": "match",
    "sport": "Cricket",
    "date": "2024-01-15",
    "slot": "10:00-11:30",
    "basePrice": 1200,
    "userEmail": "user@email.com"
  }
  ```
- **Response**: 
  ```json
  {
    "isValid": true,
    "message": "Coupon applied successfully",
    "discount": 100,
    "finalPrice": 1100,
    "couponData": {
      "code": "SUMMER20",
      "discountType": "flat",
      "discountValue": 100,
      "discountAmount": 100
    }
  }
  ```
- **Validation Checks**:
  - Code exists
  - Coupon is active
  - Not expired
  - User is assigned (if list not empty)
  - Usage limit not exceeded
  - Booking type matches
  - Sport matches (if specified)
  - Slot matches (if specified)
  - Minimum amount met

#### 2. List Available Coupons
- **Endpoint**: `GET /api/coupons/list`
- **Query Params**:
  - `userEmail` (required)
  - `date` (optional)
  - `slot` (optional)
  - `sport` (optional)
  - `bookingType` (optional)
- **Response**: Array of available coupons for user

## Utilities

### `lib/couponValidation.ts`
Core validation and utility functions:

#### 1. `validateCoupon(code, bookingType, sport, date, slot, basePrice, userEmail)`
- Validates coupon against all criteria
- Returns: `{isValid, message, discount?, finalPrice?, couponData?}`

#### 2. `getUserCoupons(userEmail)`
- Gets all active, non-expired coupons for user
- Returns: Array of coupon codes and discount info

#### 3. `getSlotCoupons(date, slot, sport, bookingType, userEmail)`
- Gets coupons applicable to specific slot
- Returns: Array of slot-specific coupons

#### 4. `incrementCouponUsage(couponCode)`
- Increments usedCount after successful booking
- Returns: boolean (success/failure)

#### 5. `calculateFinalPriceWithCoupon(...)`
- Combines day-based discount with coupon discount
- Returns: `{basePrice, basePriceAfterDayDiscount, dayDiscount, couponDiscount, finalPrice, couponApplied}`
- Formula: `finalPrice = basePrice - dayDiscount - couponDiscount`

## Frontend Components

### 1. `components/AdminCouponManager.tsx`
Complete admin dashboard for coupon management:
- **Create Form**: All coupon fields with validation
- **List View**: Display all coupons with filters
- **Actions**: Edit, delete, toggle active status
- **Features**:
  - Inline editing
  - Sport multi-select
  - Email list for user assignment
  - Real-time status badges
  - Usage tracking display

### 2. `components/CouponApplier.tsx`
User-facing coupon application component:
- **Manual Input**: Enter coupon code
- **Available Coupons**: Show applicable coupons for slot
- **Real-time Validation**: Instant feedback
- **Discount Display**: Show discount amount and final price
- **One-click Application**: Click available coupon to apply
- **Integration**: Callback to parent component on successful apply

## Integration Points

### Booking Flow Integration
1. **Display Available Coupons**: Load `CouponApplier` in booking form
2. **Calculate Final Price**: Use `calculateFinalPriceWithCoupon()` utility
3. **Store Coupon Code**: Include in booking submission
4. **Validate at Checkout**: Re-validate coupon in booking creation API
5. **Increment Usage**: Call `incrementCouponUsage()` after booking success

### Example Integration in Booking Form
```typescript
// Show coupons
<CouponApplier
  bookingType={bookingType}
  sport={sport}
  date={date}
  slot={slot}
  basePrice={basePrice}
  userEmail={userEmail}
  onCouponApply={(coupon) => {
    setAppliedCoupon(coupon);
    setFinalPrice(coupon.finalPrice);
  }}
/>

// Calculate price with coupon
const pricing = await calculateFinalPriceWithCoupon(
  bookingType,
  date,
  sport,
  basePrice,
  appliedCoupon?.code,
  userEmail
);
```

## Error Handling & Messages

The system validates and provides clear error messages for:

| Scenario | Message |
|----------|---------|
| Invalid code | "Invalid coupon code" |
| Not active | "This coupon is no longer active" |
| Expired | "This coupon has expired" |
| Not assigned to user | "This coupon is not assigned to you" |
| Usage limit reached | "This coupon has reached its usage limit" |
| Wrong booking type | "This coupon is not valid for {bookingType} bookings" |
| Wrong sport | "This coupon is not valid for {sport}" |
| Wrong slot | "This coupon is not valid for the selected date and time slot" |
| Min amount not met | "Minimum booking amount of ₹{amount} required for this coupon" |
| Per-user limit reached | "You've used this coupon maximum times" |

## Features Implemented

✅ **Admin Control**
- Create coupons with all parameters
- Edit existing coupons (except code)
- Delete coupons
- Enable/disable coupons
- View usage statistics
- Filter coupons (active status, sport)

✅ **User Assignment**
- Public coupons (visible to all)
- User-specific coupons (assigned to email list)
- Automatic filtering based on assignment

✅ **Slot-Specific Filtering**
- Applicable slots (date + time slot specific)
- Sport filtering
- Booking type filtering
- Empty selections = all (apply to all slots/sports/types)

✅ **Discount Types**
- Flat discount (₹ amount)
- Percentage discount (% of booking price)
- Validation (percent can't exceed 100%)

✅ **Constraints & Limits**
- Minimum booking amount required
- Expiry date validation
- Usage limit (total across all users)
- Per-user usage limit
- Current usage tracking

✅ **Dual-Discount Support**
- Works with day-based pricing discount
- Coupon discount applied on top of day discount
- Final price = base - day discount - coupon discount
- Prevents negative final prices

✅ **Validation at Multiple Layers**
- API-level validation (on apply)
- Database-level validation (schema constraints)
- Business logic validation (expiry, limits, assignment)
- Can be re-validated at final booking creation

## Database Indexes for Performance

```javascript
code: { unique: true, sparse: true }           // Quick lookup by code
isActive + expiryDate: { }                     // Efficient filtering of active coupons
assignedUsers: { }                             // User-specific coupon queries
createdAt: { }                                 // Sorting by creation date
```

## Testing Scenarios

### Admin Scenarios
1. Create coupon with all fields
2. Create coupon with minimal fields (defaults applied)
3. Create duplicate code → Error
4. Edit coupon discount value
5. Delete coupon
6. Toggle coupon active status
7. View all active coupons
8. Filter by sport
9. Filter by active status with pagination

### User Scenarios
1. Validate valid coupon for their slot
2. Validate expired coupon → Error
3. Validate coupon not assigned to them → Error
4. Validate coupon with wrong sport → Error
5. Validate coupon with wrong booking type → Error
6. Validate coupon below minimum amount → Error
7. View available coupons for their slot
8. Apply coupon and see discount in real-time
9. Usage limit reached → Error
10. Per-user limit reached → Error

### Integration Scenarios
1. Day discount + coupon discount stacking
2. Prevent coupon application above base price
3. Increment usage after successful booking
4. Re-validate coupon at booking creation
5. Show breakdown of all discounts in booking summary

## Files Created/Modified

### New Files
- `lib/couponValidation.ts` (Validation utilities)
- `models/Coupon.ts` (Database schema)
- `app/api/admin/coupons/create/route.ts` (Create API)
- `app/api/admin/coupons/list/route.ts` (List API)
- `app/api/admin/coupons/update/route.ts` (Update API)
- `app/api/admin/coupons/delete/route.ts` (Delete API)
- `app/api/admin/coupons/toggle/route.ts` (Toggle API)
- `app/api/coupons/validate/route.ts` (User validation API)
- `app/api/coupons/list/route.ts` (User coupon list API)
- `components/AdminCouponManager.tsx` (Admin UI)
- `components/CouponApplier.tsx` (User coupon component)

### To Modify
- `app/api/turf-bookings/create/route.ts` (Integrate coupon validation & usage increment)
- `components/TurfBookingForm.tsx` (Add CouponApplier component)
- `types/index.ts` (Add Coupon types if needed)

## Next Steps

1. **Integrate with Booking Creation**:
   - Update `turf-bookings/create` API to validate coupon
   - Call `incrementCouponUsage()` after booking success
   - Include coupon code in booking record

2. **Add to Booking Form**:
   - Import and render `CouponApplier` component
   - Handle coupon apply callback
   - Display final price with coupon discount

3. **Add to Admin Gallery**:
   - Add CouponManager tab/section to admin dashboard
   - Import and render `AdminCouponManager` component

4. **Testing**:
   - Create test coupons for each scenario
   - Verify validation at all layers
   - Test dual-discount stacking
   - Verify usage tracking

5. **Documentation**:
   - Add coupon section to user guide
   - Add admin guide for coupon management
   - Document API responses and error codes

## Environment Variables (If Needed)

Already using existing JWT secret from environment:
- `JWT_SECRET`: For admin token verification (already used)
- MongoDB connection: (already configured)

No additional environment variables required.
