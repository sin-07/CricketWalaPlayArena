# Coupon System - Quick Integration Guide

## Step 1: Update Turf Booking Creation API

**File**: `app/api/turf-bookings/create/route.ts`

Add these imports at the top:
```typescript
import { validateCoupon, incrementCouponUsage } from '@/lib/couponValidation';
```

In the booking creation logic, after calculating final price:

```typescript
// Validate coupon if provided
let couponDiscount = 0;
if (body.couponCode && body.userEmail) {
  const couponResult = await validateCoupon(
    body.couponCode,
    body.bookingType,
    body.sport,
    body.date,
    body.slot,
    finalPrice, // Use price after day discount
    body.userEmail
  );

  if (couponResult.isValid && couponResult.discount) {
    couponDiscount = couponResult.discount;
    finalPrice = couponResult.finalPrice; // Update to final price
  } else {
    return NextResponse.json(
      { error: couponResult.message },
      { status: 400 }
    );
  }
}

// ... Save booking with couponCode field ...

// Increment coupon usage after successful booking
if (body.couponCode) {
  await incrementCouponUsage(body.couponCode);
}
```

Update booking save to include coupon:
```typescript
const booking = await TurfBooking.create({
  // ... existing fields ...
  couponCode: body.couponCode || null,
  basePrice: body.basePrice,
  dayDiscount: dayDiscountAmount,
  couponDiscount: couponDiscount,
  finalPrice: finalPrice,
});
```

## Step 2: Add Coupon Fields to TurfBooking Model

**File**: `models/TurfBooking.ts`

Add these fields to the schema:
```typescript
couponCode: {
  type: String,
  default: null,
},
dayDiscount: {
  type: Number,
  default: 0,
},
couponDiscount: {
  type: Number,
  default: 0,
},
```

## Step 3: Update Booking Form to Show Coupons

**File**: `components/TurfBookingForm.tsx`

Add these imports:
```typescript
import CouponApplier from '@/components/CouponApplier';
import { calculateFinalPriceWithCoupon } from '@/lib/couponValidation';
```

Add state for coupon:
```typescript
const [appliedCoupon, setAppliedCoupon] = useState<{
  code: string;
  discount: number;
  finalPrice: number;
} | null>(null);
```

In the form JSX, add CouponApplier component (before payment section):
```typescript
{selectedSlot && (
  <CouponApplier
    bookingType={bookingType}
    sport={selectedSport}
    date={selectedDate}
    slot={selectedSlot}
    basePrice={bookingPrice.finalPrice} // Use price after day discount
    userEmail={userEmail || 'guest'}
    onCouponApply={(coupon) => {
      setAppliedCoupon(coupon);
    }}
  />
)}
```

Update the booking submission to include coupon:
```typescript
const response = await fetch('/api/turf-bookings/create', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    // ... existing fields ...
    couponCode: appliedCoupon?.code || null,
  }),
});
```

Update pricing display to show coupon discount:
```typescript
{appliedCoupon && (
  <div className="bg-green-50 border border-green-200 rounded-lg p-3 mt-2">
    <p className="text-sm text-green-800">
      Coupon Applied: {appliedCoupon.code}
    </p>
    <p className="text-sm text-green-700 font-semibold">
      Coupon Discount: -₹{appliedCoupon.discount}
    </p>
    <p className="text-lg font-bold text-green-900 mt-1">
      Final Price: ₹{appliedCoupon.finalPrice}
    </p>
  </div>
)}
```

## Step 4: Add to Admin Dashboard

**File**: `app/admin/page.tsx` (or wherever admin dashboard is)

Import the admin component:
```typescript
import AdminCouponManager from '@/components/AdminCouponManager';
```

Add a tab or section for coupons:
```typescript
// If using tabs:
<AdminCouponManager />

// Or in tabs:
{activeTab === 'coupons' && <AdminCouponManager />}
```

## Step 5: Add Type Definitions (Optional)

**File**: `types/index.ts`

Add coupon types:
```typescript
export interface ICoupon {
  _id: string;
  code: string;
  discountType: 'flat' | 'percent';
  discountValue: number;
  applicableSlots: Array<{ date: string; slot: string }>;
  sport: string[];
  bookingType: 'match' | 'practice' | 'both';
  assignedUsers: string[];
  minAmount: number;
  expiryDate: Date;
  usageLimit: number;
  usedCount: number;
  perUserLimit: number;
  isActive: boolean;
  createdBy: string;
  createdAt: Date;
  updatedAt: Date;
}
```

## Testing the Integration

### 1. Create a Test Coupon
- Go to admin dashboard → Coupons
- Click "Create Coupon"
- Fill in details:
  - Code: `TEST20`
  - Discount Type: Flat
  - Discount Value: 200
  - Expiry: Future date
  - Booking Type: Both
  - Sports: Leave empty (all sports)
- Click "Create Coupon"

### 2. Book a Slot and Apply Coupon
- Go to booking page
- Select sport, date, slot
- Scroll to "Have a Coupon Code?"
- Enter `TEST20`
- See available coupons listed
- Click Apply or enter manually
- Verify discount is applied correctly
- Book and complete payment

### 3. Verify in Database
- Check TurfBooking document
- Confirm couponCode, dayDiscount, couponDiscount, finalPrice are saved

### 4. Check Usage
- Go to admin dashboard → Coupons
- Click on TEST20 coupon
- Verify usedCount incremented

## Dual Discount Example

**Scenario**: Day: Monday (30% off), Coupon: 200 flat
```
Base Price: ₹1000
Day Discount (30%): -₹300
Price After Day Discount: ₹700

Coupon Discount: -₹200
Final Price: ₹500

Total Savings: ₹500 (50%)
```

## Validation Points

The coupon is validated at:
1. **Apply Coupon API** (`POST /api/coupons/validate`)
   - All business logic checks
   - Returns discount information

2. **Booking Creation API** (`POST /api/turf-bookings/create`)
   - Re-validates coupon before saving
   - Prevents misuse/double application
   - Increments usage count

This two-layer validation ensures security and prevents edge cases.

## Common Issues & Solutions

### Issue: Coupon not showing in available list
**Solution**: Check if:
- Coupon is active (`isActive: true`)
- Coupon not expired
- User is assigned OR assignedUsers is empty
- Sport matches OR sport list is empty
- Booking type matches
- Current date is past creation date

### Issue: Coupon validation fails with "not valid for this slot"
**Solution**: 
- If applicableSlots is empty, all slots are valid
- If applicableSlots has values, slot must match exactly (date + time)
- Format must be: date="YYYY-MM-DD", slot="HH:MM-HH:MM"

### Issue: Discount shows but not applied to final price
**Solution**:
- Make sure turf-bookings/create API is updated
- Make sure booking submission includes `couponCode`
- Check TurfBooking schema has `couponDiscount` field

## Next Advanced Features (Future)

- Coupon auto-apply for eligible users
- Bulk coupon assignment via CSV
- Coupon performance analytics
- Seasonal coupon templates
- Referral coupon system
- Birthday/anniversary coupons
- Coupon expiry notifications

